<!DOCTYPE html>
<html>

<head>
    <title>Fruit Grader Make Prediction</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>

<body>
    <div class="container">
        <h1 class="text-center mt-5 display-5">Fruit Grader</h1>
        <hr>
        <div class="row">
            <div class="col">
                <div class="card mb-3">
                    <div class="card-header">
                        <form class="text-center">
                            <div class="form-group">
                                <input type="file" id="image" name="image" class="form-control-file"
                                    onchange="previewImage()">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="remove_background"
                                        name="remove_background">
                                    <label class="form-check-label" for="remove_background">
                                        Remove Background
                                    </label>
                                </div>
                                <input type="button" value="Submit" class="btn btn-primary btn-block" onclick="grade()">
                            </div>
                        </form>
                    </div>
                    <div class="row g-0">
                        <div class="col-md-4">
                            <img id="preview" class="img-fluid rounded-start"
                                src="{{url_for('static', filename='fruit_placeholder.jpg')}}" alt="Image preview"
                                style="display: block; max-height: 350px; margin: auto;">
                        </div>
                        <div class="col-md-8">
                            <div class="card-body">
                                <h3 id="title" class="card-title text-center display-6">Choose fruit image</h3>
                                <div id="spinner" style="display: flex; align-items: center; justify-content: center">
                                </div>
                                <table class="table" style="display: none;">
                                    <tbody>
                                        <tr>
                                            <th scope="row">Fruit</th>
                                            <td id="result">Fruit</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Size</th>
                                            <td id="size-result">Size</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Shape</th>
                                            <td id="shape-result">Shape</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Color</th>
                                            <td id="color-result">Color</td>
                                        </tr>
                                        <tr>
                                            <th scope="row">Surface</th>
                                            <td id="surface-result">Surface</td>
                                        </tr>
                                        <tr class="table-light">
                                            <th scope="row">Score</th>
                                            <td id="score-result">Score</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <th scope="row">Grade</th>
                                            <td id="grade-result">Grade</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a class="btn btn-secondary" type="button" href="http://127.0.0.1:8000/predictions">Previous
                                predictions</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.3.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
        <script>
            function previewImage() {
                // get the selected image
                let image = document.querySelector("#image").files[0];

                // create a URL for the image
                let objectURL = URL.createObjectURL(image);

                // set the src of the image preview element to the URL
                document.querySelector("#preview").src = objectURL;
                document.querySelector("#preview").style.display = "block";

                document.querySelector(".table").style.display = "none";
                document.querySelector("#title").innerHTML = "Submit to start grading";
            }

            function grade() {

                // adding Spinner
                var opts = {
                    lines: 13, // The number of lines to draw
                    length: 38, // The length of each line
                    width: 17, // The line thickness
                    radius: 45, // The radius of the inner circle
                    scale: 1, // Scales overall size of the spinner
                    corners: 1, // Corner roundness (0..1)
                    color: '#5bc0de', // CSS color or array of colors
                    fadeColor: 'transparent', // CSS color or array of colors
                    speed: 1, // Rounds per second
                    rotate: 0, // The rotation offset
                    animation: 'spinner-line-fade-quick', // The CSS animation name for the lines
                    direction: 1, // 1: clockwise, -1: counterclockwise
                    zIndex: 2e9, // The z-index (defaults to 2000000000)
                    className: 'spinner', // The CSS class to assign to the spinner
                    top: '50%', // Top position relative to parent
                    left: '50%', // Left position relative to parent
                    shadow: '0 0 1px transparent', // Box-shadow for the lines
                    position: 'absolute' // Element positioning
                };

                let target = document.getElementById('spinner');
                let spinner = new Spinner(opts).spin(target);

                // get the form element
                let image = document.querySelector("#image").files[0];
                let remove_background = document.querySelector("#remove_background").checked;
                let formData = new FormData();
                formData.append("image", image);
                formData.append("remove_background", remove_background);

                document.querySelector(".table").style.display = "none";
                document.querySelector("#title").innerHTML = "Processing";

                document.querySelector("#result").innerHTML = "";
                document.querySelector("#size-result").innerHTML = "";
                document.querySelector("#shape-result").innerHTML = "";
                document.querySelector("#color-result").innerHTML = "";
                document.querySelector("#surface-result").innerHTML = "";
                document.querySelector("#score-result").innerHTML = "";
                document.querySelector("#grade-result").innerHTML = "";

                // make a POST request to the server
                fetch("http://127.0.0.1:8000/predict", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        spinner.stop();

                        if (data.error) {
                            alert(data.error);
                            document.querySelector("#title").innerHTML = "Error";
                        } else {
                            console.log(data)
                            document.querySelector(".table").style.display = "table";
                            document.querySelector("#title").innerHTML = "Result";

                            document.querySelector("#result").innerHTML = data.label;
                            document.querySelector("#size-result").innerHTML = data.fruit_predictions[0].fruit_label;
                            document.querySelector("#shape-result").innerHTML = data.fruit_predictions[1].fruit_label;
                            document.querySelector("#color-result").innerHTML = data.fruit_predictions[2].fruit_label;
                            document.querySelector("#surface-result").innerHTML = data.fruit_predictions[3].fruit_label;
                            document.querySelector("#score-result").innerHTML = data.total_score;
                            document.querySelector("#grade-result").innerHTML = data.fruit_grade;
                        }
                    })
                    .catch(error => {
                        spinner.stop();
                        console.error(error);

                        document.querySelector(".table").style.display = "none";
                        document.querySelector("#title").innerHTML = "Error Occured";


                        alert("An error occurred while trying to classify the image. Please try again later.");
                    });
            }
        </script>
</body>

</html>